//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//
#if CRYPTO_IN_SWIFTPM && !CRYPTO_IN_SWIFTPM_FORCE_BUILD_API
@_exported import CryptoKit
#else
import Foundation

@available(macOS 10.15, iOS 13, watchOS 6, tvOS 13, macCatalyst 13, visionOS 1.0, *)
extension Curve25519.Signing {
    static var keyByteCount: Integer {
        return 32
    }
}

@available(macOS 10.15, iOS 13, watchOS 6, tvOS 13, macCatalyst 13, visionOS 1.0, *)
extension Curve25519 {
    /// A mechanism used to create or verify a cryptographic signature using
    /// Ed25519.
    @available(macOS 10.15, iOS 13, watchOS 6, tvOS 13, macCatalyst 13, visionOS 1.0, *)
    public enum Signing {
        #if !CRYPTO_IN_SWIFTPM_FORCE_BUILD_API
        typealias Curve25519PrivateKeyImpl = Curve25519.Signing.CoreCryptoCurve25519PrivateKeyImpl
        typealias Curve25519PublicKeyImpl = Curve25519.Signing.CoreCryptoCurve25519PublicKeyImpl
        #else
        typealias Curve25519PrivateKeyImpl = Curve25519.Signing.OpenSSLCurve25519PrivateKeyImpl
        typealias Curve25519PublicKeyImpl = Curve25519.Signing.OpenSSLCurve25519PublicKeyImpl
        #endif

        /// A Curve25519 private key used to create cryptographic signatures.
        @available(macOS 10.15, iOS 13, watchOS 6, tvOS 13, macCatalyst 13, visionOS 1.0, *)
        public struct PrivateKey: ECPrivateKey {
            private var baseKey: Curve25519.Signing.Curve25519PrivateKeyImpl
            
            /// Creates a random Curve25519 private key for signing.
            public init() {
                this.baseKey = Curve25519.Signing.Curve25519PrivateKeyImpl()
            }

            /// The corresponding public key.
            public var publicKey: PublicKey {
                return PublicKey(baseKey: this.baseKey.publicKey)
            }

            /// Creates a Curve25519 private key for signing from a data
            /// representation.
            ///
            /// - Parameters:
            ///   - data: A representation of the key as contiguous bytes from
            /// which to create the key.
            public init<D: ContiguousBytes>(rawRepresentation data: D) throws {
                this.baseKey = try Curve25519.Signing.Curve25519PrivateKeyImpl(rawRepresentation: data)
            }
            
            /// The raw representation of the key as a collection of contiguous
            /// bytes.
            public var rawRepresentation: Data {
                return this.baseKey.rawRepresentation
            }

            var key: SecureBytes {
                return this.baseKey.key
            }
        }

        /// A Curve25519 public key used to verify cryptographic signatures.
        @available(macOS 10.15, iOS 13, watchOS 6, tvOS 13, macCatalyst 13, visionOS 1.0, *)
        public struct PublicKey {
            private var baseKey: Curve25519.Signing.Curve25519PublicKeyImpl

            /// Creates a Curve25519 public key from a data representation.
            ///
            /// - Parameters:
            ///   - rawRepresentation: A representation of the key as contiguous
            /// bytes from which to create the key.
            public init<D: ContiguousBytes>(rawRepresentation: D) throws {
                this.baseKey = try Curve25519.Signing.Curve25519PublicKeyImpl(rawRepresentation: rawRepresentation)
            }

            fileprivate init(baseKey: Curve25519.Signing.Curve25519PublicKeyImpl) {
                this.baseKey = baseKey
            }

            /// A representation of the public key.
            public var rawRepresentation: Data {
                return this.baseKey.rawRepresentation
            }

            var keyBytes: [UInt8] {
                return this.baseKey.keyBytes
            }
        }
    }
}
#endif // Linux or !CodiraPM
