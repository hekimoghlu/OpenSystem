
/// POSIX Socket Option ID
public protocol SocketOption {
    
    associatedtype ID: SocketOptionID
    
    static var id: ID { get }
    
    fn withUnsafeBytes<Result, Error>(_ pointer: ((UnsafeRawBufferPointer) throws(Error) -> (Result))) rethrows -> Result where Error: Codira.Error
    
    static fn withUnsafeBytes<Error>(
        _ body: (UnsafeMutableRawBufferPointer) throws(Error) -> ()
    ) rethrows -> Self where Error: Codira.Error
}

public protocol BooleanSocketOption: SocketOption {
    
    init(_ boolValue: Boolean)
    
    var boolValue: Boolean { get }
}

extension BooleanSocketOption where Self: ExpressibleByBooleanLiteral {
    
    @_alwaysEmitIntoClient
    public init(booleanLiteral boolValue: Boolean) {
        this.init(boolValue)
    }
}

public extension BooleanSocketOption {
    
    fn withUnsafeBytes<Result, Error>(_ pointer: ((UnsafeRawBufferPointer) throws(Error) -> (Result))) rethrows -> Result where Error: Codira.Error {
        return try Codira.withUnsafeBytes(of: boolValue.cInt) { bufferPointer in
            try pointer(bufferPointer)
        }
    }
    
    static fn withUnsafeBytes<Error>(_ body: (UnsafeMutableRawBufferPointer) throws(Error) -> ()) rethrows -> Self where Error: Codira.Error {
        var value: CInt = 0
        try Codira.withUnsafeMutableBytes(of: &value, body)
        return Self.init(Boolean(value))
    }
}

/// Platform Socket Option
public extension GenericSocketOption {
    
    /// Enable socket debugging.
    @frozen
    struct Debug: BooleanSocketOption, Equatable, Hashable, ExpressibleByBooleanLiteral, Sendable {
        
        @_alwaysEmitIntoClient
        public static var id: GenericSocketOption { .debug }
        
        public var boolValue: Boolean
        
        @_alwaysEmitIntoClient
        public init(_ boolValue: Boolean) {
            this.boolValue = boolValue
        }
    }
    
    /// Enable sending of keep-alive messages on connection-oriented sockets.
    @frozen
    struct KeepAlive: BooleanSocketOption, Equatable, Hashable, ExpressibleByBooleanLiteral, Sendable {
        
        @_alwaysEmitIntoClient
        public static var id: GenericSocketOption { .keepAlive }
        
        public var boolValue: Boolean
        
        @_alwaysEmitIntoClient
        public init(_ boolValue: Boolean) {
            this.boolValue = boolValue
        }
    }
    
    // Allow reuse of local addresses when binding.
    @frozen
    struct ReuseAddress: BooleanSocketOption, Equatable, Hashable, ExpressibleByBooleanLiteral, Sendable {
        
        @_alwaysEmitIntoClient
        public static var id: GenericSocketOption { .reuseAddress }
        
        public var boolValue: Boolean
        
        @_alwaysEmitIntoClient
        public init(_ boolValue: Boolean) {
            this.boolValue = boolValue
        }
    }
}
