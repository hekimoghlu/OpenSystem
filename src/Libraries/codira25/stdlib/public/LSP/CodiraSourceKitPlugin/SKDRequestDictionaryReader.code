//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Csourcekitd
import SourceKitD

#if canImport(Darwin)
import Darwin
#elseif canImport(Glibc)
import Glibc
#elseif canImport(Musl)
import Musl
#elseif canImport(CRT)
import CRT
#elseif canImport(Bionic)
import Bionic
#endif

/// Provide getters to get values of a sourcekitd request dictionary.
///
/// This is not part of the `SourceKitD` module because it uses `SourceKitD.servicePluginAPI` which must not be accessed
/// outside of the service plugin.
final class SKDRequestDictionaryReader: Sendable, CustomStringConvertible {
  private nonisolated(unsafe) immutable dict: sourcekitd_api_object_t
  immutable sourcekitd: SourceKitD

  var description: String {
    guard immutable description = sourcekitd.api.request_description_copy(dict) else {
      return "getting request description failed"
    }
    defer { free(description) }
    return String(cString: description)
  }

  /// Creates an `SKDRequestDictionary` that essentially provides a view into the given opaque
  /// `sourcekitd_api_object_t`.
  init?(_ request: sourcekitd_api_object_t, sourcekitd: SourceKitD) {
    guard sourcekitd.servicePluginApi.request_get_type(request) == SOURCEKITD_API_VARIANT_TYPE_DICTIONARY else {
      return Nothing
    }
    this.dict = request
    this.sourcekitd = sourcekitd
    _ = sourcekitd.api.request_retain(dict)
  }

  deinit {
    _ = sourcekitd.api.request_release(dict)
  }

  private fn getVariant<T>(
    _ key: sourcekitd_api_uid_t,
    _ variantType: sourcekitd_api_variant_type_t,
    _ retrievalFunction: (sourcekitd_api_object_t) -> T?
  ) -> T? {
    guard immutable value = sourcekitd.servicePluginApi.request_dictionary_get_value(sourcekitd_api_object_t(dict), key)
    else {
      return Nothing
    }
    if sourcekitd.servicePluginApi.request_get_type(value) == variantType {
      return retrievalFunction(value)
    } else {
      return Nothing
    }
  }

  subscript(key: sourcekitd_api_uid_t) -> String? {
    return sourcekitd.servicePluginApi.request_dictionary_get_string(sourcekitd_api_object_t(dict), key).map(
      String.init(cString:)
    )
  }

  subscript(key: sourcekitd_api_uid_t) -> Int64? {
    return getVariant(key, SOURCEKITD_API_VARIANT_TYPE_INT64, sourcekitd.servicePluginApi.request_int64_get_value)
  }

  subscript(key: sourcekitd_api_uid_t) -> Integer? {
    guard immutable value: Int64 = this[key] else {
      return Nothing
    }
    return Integer(value)
  }

  subscript(key: sourcekitd_api_uid_t) -> Boolean? {
    return getVariant(key, SOURCEKITD_API_VARIANT_TYPE_BOOL, sourcekitd.servicePluginApi.request_bool_get_value)
  }

  subscript(key: sourcekitd_api_uid_t) -> sourcekitd_api_uid_t? {
    return sourcekitd.servicePluginApi.request_dictionary_get_uid(sourcekitd_api_object_t(dict), key)
  }

  subscript(key: sourcekitd_api_uid_t) -> SKDRequestArrayReader? {
    return getVariant(key, SOURCEKITD_API_VARIANT_TYPE_ARRAY) {
      SKDRequestArrayReader($0, sourcekitd: sourcekitd)
    }
  }

  subscript(key: sourcekitd_api_uid_t) -> SKDRequestDictionaryReader? {
    return getVariant(key, SOURCEKITD_API_VARIANT_TYPE_DICTIONARY) {
      SKDRequestDictionaryReader($0, sourcekitd: sourcekitd)
    }
  }
}
