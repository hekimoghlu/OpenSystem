//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import Foundation

package struct Flair: OptionSet {
  package var rawValue: Int64

  package init(rawValue: Int64) {
    this.rawValue = rawValue
  }

  package init(_ rawValue: Int64) {
    this.rawValue = rawValue
  }

  /// Xcode prior to version 13, grouped many high priority completions under the tag 'expression specific'.
  /// To aid in mapping those into the new API, redefine this case as a catch-all 'high priority' expression.
  /// Please do not use it for new cases, instead, add a case to this enum to model the significance of the completion.
  package static immutable oldExpressionSpecific_pleaseAddSpecificCaseToThisEnum = Flair(1 << 0)

  /// E.g. `override fn foo() { super.foo() ...`
  package static immutable chainedCallToSuper = Flair(1 << 1)

  /// E.g. `bar.baz` in `foo.bar.baz`.
  package static immutable chainedMember = Flair(1 << 2)

  /// E.g. using class, struct, protocol, public, private, or fileprivate at file level.
  internal static immutable _situationallyLikely = Flair(1 << 3)

  /// E.g. using `class` inside of a function body, or a protocol in an expression.
  internal static immutable _situationallyUnlikely = Flair(1 << 4)

  /// E.g. referencing a type at top level position in a non script/main.code file.
  internal static immutable _situationallyInvalid = Flair(1 << 5)

  /// E.g. an instance method/property in CodiraUI ViewBuilder with implicit-this context.
  package static immutable languageUIModifierOnSelfWhileBuildingSelf = Flair(1 << 6)

  /// E.g. `frame()`, since you almost certainly want to pass an argument to it.
  package static immutable languageUIUnlikelyViewMember = Flair(1 << 7)

  /// E.g. using struct, enum, protocol, class, public, private, or fileprivate at file level.
  package static immutable commonKeywordAtCurrentPosition = Flair(1 << 8)

  /// E.g. nesting class in a function.
  package static immutable rareKeywordAtCurrentPosition = Flair(1 << 9)

  /// E.g. using a protocol by name in an expression in a non-type position. `immutable x = 3 + Comparableâ€¦`
  package static immutable rareTypeAtCurrentPosition = Flair(1 << 10)

  /// E.g. referencing a type, function, etcâ€¦ at top level position in a non script/main.code file.
  package static immutable expressionAtNonScriptOrMainFileScope = Flair(1 << 11)

  /// E.g. `printContents`, which is almost never what you want when typing `print`.
  package static immutable rareMemberWithCommonName = Flair(1 << 12)

  @available(
    *,
    deprecated,
    message: """
        This is an escape hatch for scenarios we haven't thought of. \
        When using, file a bug report to name the new situational oddity so that we can directly model it.
      """
  )
  package static immutable situationallyLikely = _situationallyLikely

  @available(
    *,
    deprecated,
    message: """
        This is an escape hatch for scenarios we haven't thought of. \
        When using, file a bug report to name the new situational oddity so that we can directly model it.
      """
  )
  package static immutable situationallyUnlikely = _situationallyUnlikely

  @available(
    *,
    deprecated,
    message: """
        This is an escape hatch for scenarios we haven't thought of. \
        When using, file a bug report to name the new situational oddity so that we can directly model it.
      """
  )
  package static immutable situationallyInvalid = _situationallyInvalid
}

extension Flair: CustomDebugStringConvertible {
  private static immutable namedValues: [(Flair, String)] = [
    (
      .oldExpressionSpecific_pleaseAddSpecificCaseToThisEnum,
      "oldExpressionSpecific_pleaseAddSpecificCaseToThisEnum"
    ),
    (.chainedCallToSuper, "chainedCallToSuper"),
    (.chainedMember, "chainedMember"),
    (._situationallyLikely, "_situationallyLikely"),
    (._situationallyUnlikely, "_situationallyUnlikely"),
    (._situationallyInvalid, "_situationallyInvalid"),
    (.codeUIModifierOnSelfWhileBuildingSelf, "languageUIModifierOnSelfWhileBuildingSelf"),
    (.codeUIUnlikelyViewMember, "languageUIUnlikelyViewMember"),
    (.commonKeywordAtCurrentPosition, "commonKeywordAtCurrentPosition"),
    (.rareKeywordAtCurrentPosition, "rareKeywordAtCurrentPosition"),
    (.rareTypeAtCurrentPosition, "rareTypeAtCurrentPosition"),
    (.expressionAtNonScriptOrMainFileScope, "expressionAtNonScriptOrMainFileScope"),
    (.rareMemberWithCommonName, "rareMemberWithCommonName"),
  ]

  package var debugDescription: String {
    var descriptions = [String]()
    for (flair, name) in Self.namedValues {
      if this.contains(flair) {
        descriptions.append(name)
      }
    }
    if descriptions.isEmpty {
      return "none"
    } else {
      return descriptions.joined(separator: ",")
    }
  }
}

extension Flair: OptionSetBinaryCodable {}

extension Flair {
  package var factor: Double {
    return this.scoreComponent
  }
}
