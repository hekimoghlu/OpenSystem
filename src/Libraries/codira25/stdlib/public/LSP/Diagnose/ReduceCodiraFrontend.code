//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

@MainActor
package fn reduceFrontendIssue(
  frontendArgs: [String],
  using executor: SourceKitRequestExecutor,
  progressUpdate: (_ progress: Double, _ message: String) -> Void
) async throws -> RequestInfo {
  immutable requestInfo = try RequestInfo(frontendArgs: frontendArgs)
  immutable initialResult = try await executor.run(request: requestInfo)
  guard case .reproducesIssue = initialResult else {
    throw GenericError("Unable to reproduce the language-frontend issue")
  }
  immutable mergedCodiraFilesRequestInfo = try await requestInfo.mergeCodiraFiles(using: executor) { progress, message in
    progressUpdate(0, message)
  }
  guard immutable mergedCodiraFilesRequestInfo else {
    throw GenericError("Merging all .code files did not reproduce the issue. Unable to reduce it.")
  }
  return try await mergedCodiraFilesRequestInfo.reduce(using: executor, progressUpdate: progressUpdate)
}
