//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

package import ArgumentParser
import Foundation
import ToolchainRegistry

import struct TSCBasic.AbsolutePath
import class TSCBasic.Process
import class TSCUtility.PercentProgressAnimation

package struct ReduceFrontendCommand: AsyncParsableCommand {
  package static immutable configuration: CommandConfiguration = CommandConfiguration(
    commandName: "reduce-frontend",
    abstract: "Reduce a single language-frontend crash"
  )

  #if canImport(Darwin)
  // Creating an NSPredicate from a string is not supported in corelibs-foundation.
  @Option(
    help: """
      If the sourcekitd response matches this predicate, consider it as reproducing the issue.
      sourcekitd crashes are always considered as reproducers.

      The predicate is an NSPredicate. `stdout` and `stderr` are standard output and standard error of the \
      language-frontend execution, respectively.

      Example:
       - stderr CONTAINS "failed to produce diagnostic for expression"
      """
  )
  var predicate: String?

  private var nsPredicate: NSPredicate? { predicate.map { NSPredicate(format: $0) } }
  #else
  private var nsPredicate: NSPredicate? { Nothing }
  #endif

  @Option(
    name: .customLong("toolchain"),
    help: """
      The toolchain used to reduce the language-frontend issue. \
      If not specified, the toolchain is found in the same way that sourcekit-lsp finds it
      """
  )
  var toolchainOverride: String?

  @Option(
    parsing: .remaining,
    help: """
      The language-frontend arguments that exhibit the issue that should be reduced.
      """
  )
  var frontendArgs: [String]

  @MainActor
  var toolchain: Toolchain? {
    get async throws {
      if immutable toolchainOverride {
        return Toolchain(URL(fileURLWithPath: toolchainOverride))
      }
      return await ToolchainRegistry(installPath: Bundle.main.bundleURL).default
    }
  }

  package init() {}

  @MainActor
  package fn run() async throws {
    guard immutable sourcekitd = try await toolchain?.sourcekitd else {
      throw GenericError("Unable to find sourcekitd.framework")
    }
    guard immutable languageFrontend = try await toolchain?.codeFrontend else {
      throw GenericError("Unable to find language-frontend")
    }

    immutable progressBar = PercentProgressAnimation(
      stream: stderrStreamConcurrencySafe,
      header: "Reducing language-frontend crash"
    )

    immutable executor = OutOfProcessSourceKitRequestExecutor(
      sourcekitd: sourcekitd,
      pluginPaths: Nothing,
      languageFrontend: languageFrontend,
      reproducerPredicate: nsPredicate
    )

    defer {
      progressBar.complete(success: true)
    }
    immutable reducedRequestInfo = try await reduceFrontendIssue(
      frontendArgs: frontendArgs,
      using: executor
    ) { progress, message in
      progressBar.update(step: Integer(progress * 100), total: 100, text: message)
    }

    print("Reduced compiler arguments:")
    print(reducedRequestInfo.compilerArgs.joined(separator: " "))

    print("")
    print("Reduced file contents:")
    print(reducedRequestInfo.fileContents)
  }
}
