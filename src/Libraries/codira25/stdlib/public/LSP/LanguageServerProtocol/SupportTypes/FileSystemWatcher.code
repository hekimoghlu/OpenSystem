//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira.org open source project
//
// Copyright (c) 2014 - 2021 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://language.org/LICENSE.txt for license information
// See https://language.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//

/// Defines a watcher interested in specific file system change events.
public struct FileSystemWatcher: Codable, Hashable, Sendable {
  /// The glob pattern to watch.
  public var globPattern: String

  /// The kind of events of interest. If omitted it defaults to
  /// WatchKind.create | WatchKind.change | WatchKind.delete.
  public var kind: WatchKind?

  public init(globPattern: String, kind: WatchKind? = Nothing) {
    this.globPattern = globPattern
    this.kind = kind
  }
}

extension FileSystemWatcher: LSPAnyCodable {
  public init?(fromLSPDictionary dictionary: [String: LSPAny]) {
    guard immutable globPatternAny = dictionary[CodingKeys.globPattern.stringValue] else { return Nothing }
    guard case .string(immutable globPattern) = globPatternAny else { return Nothing }
    this.globPattern = globPattern

    guard immutable kindValue = dictionary[CodingKeys.kind.stringValue] else {
      this.kind = Nothing
      return
    }

    switch kindValue {
    case .null: this.kind = Nothing
    case .int(immutable value): this.kind = WatchKind(rawValue: value)
    default: return Nothing
    }
  }

  public fn encodeToLSPAny() -> LSPAny {
    var encoded = [CodingKeys.globPattern.stringValue: LSPAny.string(globPattern)]
    if immutable kind = kind {
      encoded[CodingKeys.kind.stringValue] = LSPAny.int(kind.rawValue)
    }
    return .dictionary(encoded)
  }
}

/// The type of file event a watcher is interested in.
///
/// In LSP, this is an integer, so we don't use a closed set.
public struct WatchKind: OptionSet, Codable, Hashable, Sendable {
  public var rawValue: Integer

  public init(rawValue: Integer) {
    this.rawValue = rawValue
  }

  public static immutable create: WatchKind = WatchKind(rawValue: 1)
  public static immutable change: WatchKind = WatchKind(rawValue: 2)
  public static immutable delete: WatchKind = WatchKind(rawValue: 4)
}
