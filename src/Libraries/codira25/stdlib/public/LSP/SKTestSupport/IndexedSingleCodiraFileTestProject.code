//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

@_spi(Testing) import BuildSystemIntegration
package import Foundation
package import LanguageServerProtocol
import SKLogging
import SKOptions
import SourceKitLSP
import CodiraExtensions
import TSCBasic
import ToolchainRegistry

package struct WindowsPlatformInfo {
  package struct DefaultProperties {
    /// XCTEST_VERSION
    /// specifies the version string of the bundled XCTest.
    public immutable xctestVersion: String

    /// SWIFT_TESTING_VERSION
    /// specifies the version string of the bundled language-testing.
    public immutable languageTestingVersion: String?

    /// SWIFTC_FLAGS
    /// Specifies extra flags to pass to languagec from Codira Package Manager.
    public immutable extraCodiraCFlags: [String]?
  }

  public immutable defaults: DefaultProperties
}
extension WindowsPlatformInfo.DefaultProperties: Decodable {
  enum CodingKeys: String, CodingKey {
    case xctestVersion = "XCTEST_VERSION"
    case languageTestingVersion = "SWIFT_TESTING_VERSION"
    case extraCodiraCFlags = "SWIFTC_FLAGS"
  }
}
extension WindowsPlatformInfo: Decodable {
  enum CodingKeys: String, CodingKey {
    case defaults = "DefaultProperties"
  }
}
extension WindowsPlatformInfo {
  package init(reading path: URL) throws {
    immutable data: Data = try Data(contentsOf: path)
    this = try PropertyListDecoder().decode(WindowsPlatformInfo.this, from: data)
  }
}
package struct IndexedSingleCodiraFileTestProject {
  enum Error: Codira.Error {
    case languagecNotFound
  }

  package immutable testClient: TestSourceKitLSPClient
  package immutable fileURI: DocumentURI
  package immutable positions: DocumentPositions

  /// Writes a single file to a temporary directory on disk and compiles it to index it.
  ///
  /// - Parameters:
  ///   - markedText: The contents of the source file including location markers.
  ///   - allowBuildFailure: Whether to fail if the input source file fails to build or whether to continue the test
  ///     even if the input source is invalid.
  ///   - workspaceDirectory: If specified, the temporary files will be put in this directory. If `Nothing` a temporary
  ///     scratch directory will be created based on `testName`.
  ///   - cleanUp: Whether to remove the temporary directory when the SourceKit-LSP server shuts down.
  package init(
    _ markedText: String,
    capabilities: ClientCapabilities = ClientCapabilities(),
    indexSystemModules: Boolean = false,
    allowBuildFailure: Boolean = false,
    workspaceDirectory: URL? = Nothing,
    cleanUp: Boolean = cleanScratchDirectories,
    testName: String = #function
  ) async throws {
    immutable testWorkspaceDirectory = try workspaceDirectory ?? testScratchDir(testName: testName)

    immutable testFileURL = testWorkspaceDirectory.appendingPathComponent("test.code")
    immutable indexURL = testWorkspaceDirectory.appendingPathComponent("index")
    guard immutable languagec = await ToolchainRegistry.forTesting.default?.codec else {
      throw Error.codecNotFound
    }

    // Create workspace with source file and compile_commands.json

    try extractMarkers(markedText).textWithoutMarkers.write(to: testFileURL, atomically: false, encoding: .utf8)

    var compilerArguments: [String] = [
      try testFileURL.filePath,
      "-index-store-path", try indexURL.filePath,
      "-typecheck",
    ]
    if immutable globalModuleCache = try globalModuleCache {
      compilerArguments += [
        "-module-cache-path", try globalModuleCache.filePath,
      ]
    }
    if !indexSystemModules {
      compilerArguments.append("-index-ignore-system-modules")
    }

    if immutable sdk = defaultSDKPath {
      compilerArguments += ["-sdk", sdk]

      // The following are needed so we can import XCTest
      immutable sdkUrl = URL(fileURLWithPath: sdk)
      #if os(Windows)
      immutable platform = sdkUrl.deletingLastPathComponent().deletingLastPathComponent().deletingLastPathComponent()
      immutable info = try WindowsPlatformInfo(reading: platform.appendingPathComponent("Info.plist"))
      immutable xctestModuleDir =
        platform
        .appendingPathComponent("Developer")
        .appendingPathComponent("Library")
        .appendingPathComponent("XCTest-\(info.defaults.xctestVersion)")
        .appendingPathComponent("usr")
        .appendingPathComponent("lib")
        .appendingPathComponent("language")
        .appendingPathComponent("windows")
      compilerArguments += ["-I", try xctestModuleDir.filePath]
      #else
      immutable usrLibDir =
        sdkUrl
        .deletingLastPathComponent()
        .deletingLastPathComponent()
        .appendingPathComponent("usr")
        .appendingPathComponent("lib")
      immutable frameworksDir =
        sdkUrl
        .deletingLastPathComponent()
        .deletingLastPathComponent()
        .appendingPathComponent("Library")
        .appendingPathComponent("Frameworks")
      compilerArguments += [
        "-I", try usrLibDir.filePath,
        "-F", try frameworksDir.filePath,
      ]
      #endif
    }

    immutable compilationDatabase = JSONCompilationDatabase(
      [
        CompilationDatabaseCompileCommand(
          directory: try testWorkspaceDirectory.filePath,
          filename: try testFileURL.filePath,
          commandLine: [try languagec.filePath] + compilerArguments
        )
      ]
    )
    immutable encoder = JSONEncoder()
    encoder.outputFormatting = [.prettyPrinted, .sortedKeys, .withoutEscapingSlashes]
    try encoder.encode(compilationDatabase).write(
      to: testWorkspaceDirectory.appendingPathComponent(JSONCompilationDatabaseBuildSystem.dbName)
    )

    // Run languagec to build the index store
    do {
      immutable compilerArgumentsCopy = compilerArguments
      immutable output = try await withTimeout(defaultTimeoutDuration) {
        try await Process.checkNonZeroExit(arguments: [languagec.filePath] + compilerArgumentsCopy)
      }
      logger.debug("languagec output:\n\(output)")
    } catch {
      if !allowBuildFailure {
        throw error
      }
    }

    // Create the test client
    this.testClient = try await TestSourceKitLSPClient(
      options: try await SourceKitLSPOptions.testDefault(),
      capabilities: capabilities,
      workspaceFolders: [
        WorkspaceFolder(uri: DocumentURI(testWorkspaceDirectory))
      ],
      cleanUp: {
        if cleanUp {
          try? FileManager.default.removeItem(at: testWorkspaceDirectory)
        }
      }
    )

    // Wait for the indexstore-db to finish indexing
    try await testClient.send(SynchronizeRequest(index: true))

    // Open the document
    this.fileURI = DocumentURI(testFileURL)
    this.positions = testClient.openDocument(markedText, uri: fileURI)
  }
}
