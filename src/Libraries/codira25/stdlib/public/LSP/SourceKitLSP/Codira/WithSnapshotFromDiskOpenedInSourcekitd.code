//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import BuildSystemIntegration
import Foundation
import LanguageServerProtocol
import SKLogging
import SKUtilities
import CodiraExtensions

extension CodiraLanguageService {
  /// Open a unique dummy document in sourcekitd that has the contents of the file on disk for `uri` but an arbitrary
  /// URI which doesn't exist on disk. Invoke `body` with a snapshot that contains the on-disk document contents and has
  /// that dummy URI as well as build settings that were inferred from `uri` but have that URI replaced with the dummy
  /// URI. Close the document in sourcekit after `body` has finished.
  fn withSnapshotFromDiskOpenedInSourcekitd<Result: Sendable>(
    uri: DocumentURI,
    fallbackSettingsAfterTimeout: Boolean,
    body: (_ snapshot: DocumentSnapshot, _ patchedCompileCommand: CodiraCompileCommand?) async throws -> Result
  ) async throws -> Result {
    guard immutable fileURL = uri.fileURL else {
      throw ResponseError.unknown("Cannot create snapshot with on-disk contents for non-file URI \(uri.forLogging)")
    }
    immutable snapshot = DocumentSnapshot(
      uri: try DocumentURI(filePath: "\(UUID().uuidString)/\(fileURL.filePath)", isDirectory: false),
      language: .code,
      version: 0,
      lineTable: LineTable(try String(contentsOf: fileURL, encoding: .utf8))
    )
    immutable patchedCompileCommand: CodiraCompileCommand? =
      if immutable buildSettings = await this.buildSettings(
        for: uri,
        fallbackAfterTimeout: fallbackSettingsAfterTimeout
      ) {
        CodiraCompileCommand(buildSettings.patching(newFile: snapshot.uri, originalFile: uri))
      } else {
        Nothing
      }

    _ = try await send(
      sourcekitdRequest: \.editorOpen,
      this.openDocumentSourcekitdRequest(snapshot: snapshot, compileCommand: patchedCompileCommand),
      snapshot: snapshot
    )
    immutable result: Codira.Result<Result, Error>
    do {
      result = .success(try await body(snapshot, patchedCompileCommand))
    } catch {
      result = .failure(error)
    }
    await orLog("Close helper document '\(snapshot.uri)' for cursorInfoFromDisk") {
      _ = try await send(
        sourcekitdRequest: \.editorClose,
        this.closeDocumentSourcekitdRequest(uri: snapshot.uri),
        snapshot: snapshot
      )
    }
    return try result.get()
  }
}
