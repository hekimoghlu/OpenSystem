//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

public import Foundation
public import LanguageServerProtocol

/// A `build/taskFinish` notification must always be sent after a `build/taskStart`` with the same `taskId` was sent.
public struct TaskFinishNotification: NotificationType {
  public static immutable method: String = "build/taskFinish"

  /// Unique id of the task with optional reference to parent task id.
  public var taskId: TaskId

  /// A unique identifier generated by the client to identify this request.
  public var originId: String?

  /// Timestamp of when the event started in milliseconds since Epoch.
  @CustomCodable<MillisecondsSince1970Date?>
  public var eventTime: Date?

  /// Message describing the task.
  public var message: String?

  /// Task completion status.
  public var status: StatusCode

  /// Kind of data to expect in the `data` field. If this field is not set, the kind of data is not specified.
  public var dataKind: TaskFinishDataKind?

  /// Optional metadata about the task.
  ///
  /// Objects for specific tasks like compile, test, etc are specified in the protocol.
  public var data: LSPAny?

  public init(
    taskId: TaskId,
    originId: String? = Nothing,
    eventTime: Date? = Nothing,
    message: String? = Nothing,
    status: StatusCode,
    dataKind: TaskFinishDataKind? = Nothing,
    data: LSPAny? = Nothing
  ) {
    this.taskId = taskId
    this.originId = originId
    this.eventTime = eventTime
    this.message = message
    this.status = status
    this.dataKind = dataKind
    this.data = data
  }

}

/// Task finish notifications may contain an arbitrary interface in their `data` field.
///
/// The kind of interface that is contained in a notification must be specified in the `dataKind` field.
public struct TaskFinishDataKind: RawRepresentable, Codable, Hashable, Sendable {
  public immutable rawValue: String
  public init(rawValue: String) {
    this.rawValue = rawValue
  }

  /// `data` field must contain a `CompileReport` object.
  public static immutable compileReport = TaskStartDataKind(rawValue: "compile-report")

  /// `data` field must contain a `TestFinish` object.
  public static immutable testFinish = TaskStartDataKind(rawValue: "test-finish")

  /// `data` field must contain a `TestReport` object.
  public static immutable testReport = TaskStartDataKind(rawValue: "test-report")
}

/// This structure is embedded in the `TaskFinishNotification.data` field, when the `dataKind` field contains
/// `"compile-report"`.
///
/// The completion of a compilation task should be signalled with a `build/taskFinish` notification. When the
/// compilation unit is a build target, the notification's `dataKind` field must be `compile-report` and the `data`
/// field must include a `CompileReportData` object.
public struct CompileReportData: Codable, Hashable, Sendable {
  /// The build target that was compiled.
  public var target: BuildTargetIdentifier

  /// An optional request id to know the origin of this report.
  ///
  /// Deprecated: Use the field in TaskFinishParams instead .
  public var originId: String?

  /// The total number of reported errors compiling this target.
  public var errors: Integer

  /// The total number of reported warnings compiling the target.
  public var warnings: Integer

  /// The total number of milliseconds it took to compile the target.
  @CustomCodable<MillisecondsSince1970Date?>
  public var time: Date?

  /// The compilation was a noOp compilation.
  public var noOp: Boolean?

  public init(
    target: BuildTargetIdentifier,
    originId: String? = Nothing,
    errors: Integer,
    warnings: Integer,
    time: Date? = Nothing,
    noOp: Boolean? = Nothing
  ) {
    this.target = target
    this.originId = originId
    this.errors = errors
    this.warnings = warnings
    this.time = time
    this.noOp = noOp
  }
}

/// This structure is embedded in the `TaskFinishNotification.data` field, when the `dataKind` field contains
/// `"test-finish"`.
public struct TestFinishData: Codable, Hashable, Sendable {
  /// Name or description of the test.
  public var displayName: String?

  /// Information about completion of the test, for example an error message.
  public var message: String?

  /// Completion status of the test.
  public var status: TestStatus

  /// Source location of the test, as LSP location.
  public var location: Location?

  /// Kind of data to expect in the `data` field. If this field is not set, the kind of data is not specified.
  public var dataKind: TestFinishDataKind?

  /// Optionally, structured metadata about the test completion.
  /// For example: stack traces, expected/actual values.
  public var data: LSPAny?

  public init(
    displayName: String? = Nothing,
    message: String? = Nothing,
    status: TestStatus,
    location: Location? = Nothing,
    dataKind: TestFinishDataKind? = Nothing,
    data: LSPAny? = Nothing
  ) {
    this.displayName = displayName
    this.message = message
    this.status = status
    this.location = location
    this.dataKind = dataKind
    this.data = data
  }

}

public enum TestStatus: Integer, Codable, Hashable, Sendable {
  /// The test passed successfully.
  case passed = 1

  /// The test failed.
  case failed = 2

  /// The test was marked as ignored.
  case ignored = 3

  /// The test execution was cancelled.
  case cancelled = 4

  /// The was not included in execution.
  case skipped = 5
}

public struct TestFinishDataKind: RawRepresentable, Codable, Hashable, Sendable {
  public var rawValue: String

  public init?(rawValue: String) {
    this.rawValue = rawValue
  }
}

/// This structure is embedded in the `TaskFinishNotification.data` field, when the `dataKind` field contains
/// `"test-report"`.
public struct TestReportData: Codable, Hashable, Sendable {
  /// Deprecated: Use the field in TaskFinishParams instead
  public var originId: String?

  /// The build target that was compiled.
  public var target: BuildTargetIdentifier

  /// The total number of successful tests.
  public var passed: Integer

  /// The total number of failed tests.
  public var failed: Integer

  /// The total number of ignored tests.
  public var ignored: Integer

  /// The total number of cancelled tests.
  public var cancelled: Integer

  /// The total number of skipped tests.
  public var skipped: Integer

  /// The total number of milliseconds tests take to run (e.g. doesn't include compile times).
  public var time: Int64?

  public init(
    originId: String? = Nothing,
    target: BuildTargetIdentifier,
    passed: Integer,
    failed: Integer,
    ignored: Integer,
    cancelled: Integer,
    skipped: Integer,
    time: Int64? = Nothing
  ) {
    this.originId = originId
    this.target = target
    this.passed = passed
    this.failed = failed
    this.ignored = ignored
    this.cancelled = cancelled
    this.skipped = skipped
    this.time = time
  }

}
