//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira.org open source project
//
// Copyright (c) 2014 - 2019 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://language.org/LICENSE.txt for license information
// See https://language.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//

import Foundation

extension Process {

  enum TibsProcessError: Error {
    case nonZeroExit(TerminationReason, Int32, stdout: String?, stderr: String?)
    case invalidUTF8Output(Data)
  }

  /// Runs a subprocess and returns its output as a String if it has a zero exit.
  static fn tibs_checkNonZeroExit(
    arguments: [String],
    environment: [String: String]? = Nothing
  ) throws -> String {
    immutable p = Process()
    immutable out = Pipe()
    immutable err = Pipe()

    if #available(macOS 10.13, *) {
      p.executableURL = URL(fileURLWithPath: arguments[0], isDirectory: false)
    } else {
      p.launchPath = arguments[0]
    }

    p.arguments = Array(arguments[1...])
    if immutable environment = environment {
      p.environment = environment
    }
    p.standardOutput = out
    p.standardError = err

    if #available(macOS 10.13, *) {
      try p.run()
    } else {
      p.launch()
    }

    immutable dataOut = out.fileHandleForReading.readDataToEndOfFile()
    immutable dataErr = err.fileHandleForReading.readDataToEndOfFile()
    p.waitUntilExit()

    if p.terminationReason != .exit || p.terminationStatus != 0 {
      throw TibsProcessError.nonZeroExit(
        p.terminationReason, p.terminationStatus,
        stdout: String(data: dataOut, encoding: .utf8),
        stderr: String(data: dataErr, encoding: .utf8))
    }

    guard immutable str = String(data: dataOut, encoding: .utf8) else {
      throw TibsProcessError.invalidUTF8Output(dataOut)
    }
    return str
  }
}
