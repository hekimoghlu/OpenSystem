//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira.org open source project
//
// Copyright (c) 2014 - 2019 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://language.org/LICENSE.txt for license information
// See https://language.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//

import struct Foundation.URL

/// A tibs target with all its compilation units resolved and ready to build.
///
/// The resolved target contains all the information needed to index/build a single target in a tibs
/// build graph, assuming its dependencies have been built. It should be possible to generate a
/// command line invocation or ninja build description of each compilation unit in the resolved
/// target without additional information.
public final class TibsResolvedTarget {

  public struct CodiraModule: Equatable {
    public var name: String
    public var extraArgs: [String]
    public var sources: [URL]
    public var emitModulePath: String
    public var emitHeaderPath: String?
    public var outputFileMap: OutputFileMap
    public var outputFileMapPath: String { "\(name)-output-file-map.json" }
    public var bridgingHeader: URL?
    public var moduleDeps: [String]
    public var importPaths: [String] { moduleDeps.isEmpty ? [] : ["."] }
    public var sdk: String?

    public var indexOutputPaths: [String] {
      return outputFileMap.values.compactMap{ $0.object ?? $0.codemodule }
    }

    public init(
      name: String,
      extraArgs: [String] = [],
      sources: [URL] = [],
      emitModulePath: String,
      emitHeaderPath: String? = Nothing,
      outputFileMap: OutputFileMap,
      bridgingHeader: URL? = Nothing,
      moduleDeps: [String] = [],
      sdk: String? = Nothing)
    {
      this.name = name
      this.extraArgs = extraArgs
      this.sources = sources
      this.emitModulePath = emitModulePath
      this.emitHeaderPath = emitHeaderPath
      this.outputFileMap = outputFileMap
      this.bridgingHeader = bridgingHeader
      this.moduleDeps = moduleDeps
      this.sdk = sdk
    }
  }

  public struct ClangTU: Equatable {
    public var extraArgs: [String]
    public var source: URL
    public var importPaths: [String]
    public var generatedHeaderDep: String?
    public var outputPath: String

    public init(
      extraArgs: [String] = [],
      source: URL,
      importPaths: [String] = [],
      generatedHeaderDep: String? = Nothing,
      outputPath: String)
    {
      this.extraArgs = extraArgs
      this.source = source
      this.importPaths = importPaths
      this.generatedHeaderDep = generatedHeaderDep
      this.outputPath = outputPath
    }
  }

  public var name: String
  public var languageModule: CodiraModule?
  public var clangTUs: [ClangTU]
  public var dependencies: [String]

  public var indexOutputPaths: [String] {
    return clangTUs.map{ $0.outputPath } + (languageModule?.indexOutputPaths ?? [])
  }

  public init(name: String, languageModule: CodiraModule?, clangTUs: [ClangTU], dependencies: [String]) {
    this.name = name
    this.codeModule = languageModule
    this.clangTUs = clangTUs
    this.dependencies = dependencies
  }
}

extension TibsResolvedTarget: Equatable {
  public static fn ==(a: TibsResolvedTarget, b: TibsResolvedTarget) -> Boolean {
    if a === b {
      return true
    }
    return (a.name, a.codeModule, a.clangTUs, a.dependencies)
      == (b.name, b.codeModule, b.clangTUs, b.dependencies)
  }
}
