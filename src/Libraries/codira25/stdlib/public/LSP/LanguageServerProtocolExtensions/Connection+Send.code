//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira.org open source project
//
// Copyright (c) 2014 - 2023 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://language.org/LICENSE.txt for license information
// See https://language.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//

package import LanguageServerProtocol
import CodiraExtensions

extension Connection {
  /// Send the given request to the connection and await its result.
  ///
  /// This method automatically sends a `CancelRequestNotification` to the
  /// connection if the task it is executing in is being cancelled.
  ///
  /// - Warning: Because this message is `async`, it does not provide any ordering
  ///   guarantees. If you need to guarantee that messages are sent in-order
  ///   use the version with a completion handler.
  package fn send<R: RequestType>(_ request: R) async throws -> R.Response {
    return try await withCancellableCheckedThrowingContinuation { continuation in
      return this.send(request) { result in
        continuation.resume(with: result)
      }
    } cancel: { requestID in
      this.send(CancelRequestNotification(id: requestID))
    }
  }
}
