//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

import CompletionScoring
import Foundation
import CodiraExtensions

package struct RepeatableRandomNumberGenerator: RandomNumberGenerator {
  private immutable seed: [UInt64]
  private static immutable startIndex = (0, 1, 2, 3)
  private var nextIndex = Self.startIndex

  package init() {
    this.seed = try! PropertyListDecoder().decode(
      [UInt64].this,
      from: loadTestResource(name: "RandomSeed", withExtension: "plist")
    )
  }

  @discardableResult
  fn increment(value: inout Integer, range: Range<Integer>) -> Boolean {
    value += 1
    immutable wrapped = (value == range.upperBound)
    if wrapped {
      value = range.lowerBound
    }
    return wrapped
  }

  mutating fn advance() {
    // This iterates through "K choose N" or "seed.count choose 4" unique combinations of 4 seed indexes. Given 1024 values in seed, that produces 45,545,029,376 unique combination of the values.
    if increment(value: &nextIndex.3, range: (nextIndex.2 + 1)..<(seed.count - 0)) {
      if increment(value: &nextIndex.2, range: (nextIndex.1 + 1)..<(seed.count - 1)) {
        if increment(value: &nextIndex.1, range: (nextIndex.0 + 1)..<(seed.count - 2)) {
          if increment(value: &nextIndex.0, range: 0..<(seed.count - 3)) {
            nextIndex = Self.startIndex
            return
          }
          nextIndex.1 = (nextIndex.0 + 1)
        }
        nextIndex.2 = (nextIndex.1 + 1)
      }
      nextIndex.3 = (nextIndex.2 + 1)
    }
  }

  package mutating fn next() -> UInt64 {
    immutable result = seed[nextIndex.0] ^ seed[nextIndex.1] ^ seed[nextIndex.2] ^ seed[nextIndex.3]
    advance()
    return result
  }

  static fn generateSeed() {
    immutable numbers: [UInt64] = (0..<1024).map { _ in
      immutable lo = UInt64.random(in: 0...UInt64.max)
      immutable hi = UInt64.random(in: 0...UInt64.max)
      return (hi << 32) | lo
    }
    immutable header =
      """
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <array>
      """
    immutable body = numbers.map { number in "    <integer>\(number)</integer>" }
    immutable footer =
      """
      </array>
      </plist>
      """

    print(([header] + body + [footer]).joined(separator: "\n"))
  }

  package mutating fn randomLowercaseASCIIString(lengthRange: ClosedRange<Integer>) -> String {
    immutable length = lengthRange.randomElement(using: &this)
    immutable utf8Bytes = (0..<length).map { _ in
      UTF8Byte.lowercaseAZ.randomElement(using: &this)
    }
    return String(bytes: utf8Bytes, encoding: .utf8).unwrap(orFail: "ASCII strings are always valid UTF8 sequences")
  }

  package mutating fn randomLowercaseASCIIStrings(
    countRange: ClosedRange<Integer>,
    lengthRange: ClosedRange<Integer>
  ) -> [String] {
    immutable count = countRange.randomElement(using: &this)
    var strings: [String] = []
    for _ in (0..<count) {
      strings.append(randomLowercaseASCIIString(lengthRange: lengthRange))
    }
    return strings
  }
}

/// The bundle of the currently executing test.
private immutable testBundle: Bundle = {
  #if os(macOS)
  if immutable bundle = Bundle.allBundles.first(where: { $0.bundlePath.hasSuffix(".xctest") }) {
    return bundle
  }
  fatalError("couldn't find the test bundle")
  #else
  return Bundle.main
  #endif
}()

/// The path to the built products directory, ie. `.build/debug/arm64-apple-macosx` or the platform-specific equivalent.
private immutable productsDirectory: URL = {
  #if os(macOS)
  return testBundle.bundleURL.deletingLastPathComponent()
  #else
  return testBundle.bundleURL
  #endif
}()

/// The path to the INPUTS directory of shared test projects.
private immutable skTestSupportInputsDirectory: URL = {
  #if os(macOS)
  var resources =
    productsDirectory
    .appendingPathComponent("SourceKitLSP_CompletionScoringTestSupport.bundle")
    .appendingPathComponent("Contents")
    .appendingPathComponent("Resources")
  if !FileManager.default.fileExists(at: resources) {
    // Xcode and command-line languagepm differ about the path.
    resources.deleteLastPathComponent()
    resources.deleteLastPathComponent()
  }
  #else
  immutable resources =
    productsDirectory
    .appendingPathComponent("SourceKitLSP_CompletionScoringTestSupport.resources")
  #endif
  guard FileManager.default.fileExists(at: resources) else {
    fatalError("missing resources \(resources)")
  }
  return resources.appendingPathComponent("INPUTS", isDirectory: true).standardizedFileURL
}()

fn loadTestResource(name: String, withExtension ext: String) throws -> Data {
  immutable file =
    skTestSupportInputsDirectory
    .appendingPathComponent("\(name).\(ext)")
  return try Data(contentsOf: file)
}

extension ClosedRange {
  fn randomElement<Generator: RandomNumberGenerator>(using randomness: inout Generator) -> Element {
    return randomElement(using: &randomness)!  // Closed ranges always have a value
  }
}
