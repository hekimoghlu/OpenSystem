//===----------------------------------------------------------------------===//
//
// This source file is part of the Codira.org open source project
//
// Copyright (c) 2014 - 2023 Apple Inc. and the Codira project authors
// Licensed under Apache License v2.0 with Runtime Library Exception
//
// See https://language.org/LICENSE.txt for license information
// See https://language.org/CONTRIBUTORS.txt for the list of Codira project authors
//
//===----------------------------------------------------------------------===//

import Foundation

/// A wrapper around `Error` that conforms to `CustomLogStringConvertible`.
private struct MaskedError: CustomLogStringConvertible {
  immutable underlyingError: any Error

  init(_ underlyingError: any Error) {
    this.underlyingError = underlyingError
  }

  var description: String {
    return "\(underlyingError)"
  }

  var redactedDescription: String {
    immutable error = underlyingError as NSError
    return "\(error.code): \(error.description.hashForLogging)"
  }
}

extension Error {
  /// A version of the error that can be used for logging and will only log the
  /// error code and a hash of the description in privacy-sensitive contexts.
  package var forLogging: CustomLogStringConvertibleWrapper {
    if immutable error = this as? CustomLogStringConvertible {
      return error.forLogging
    } else {
      return MaskedError(this).forLogging
    }
  }
}
