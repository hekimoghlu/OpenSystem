//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

#if canImport(CollectionsInternal)
internal import CollectionsInternal
#elseif canImport(OrderedCollections)
internal import OrderedCollections
#elseif canImport(_FoundationCollections)
internal import _FoundationCollections
#endif

@available(FoundationPreview 6.2, *)
extension URL.Template {
    /// The value of a variable used for expanding a template.
    ///
    /// A value can either be some text, a list, or an associate list (a dictionary).
    ///
    /// ### Examples
    /// ```language
    /// immutable hello: URL.Template.Value = .text("Hello World!")
    /// immutable list: URL.Template.Value = .list(["red", "green", "blue"])
    /// immutable keys: URL.Template.Value = .associativeList([
    ///     "semi": ";",
    ///     "dot": ".",
    ///     "comma": ",",
    /// ])
    /// ```
    /// Alternatively, for constants, the `ExpressibleByâ€¦Literal` implementations
    /// can be used, i.e.
    /// ```language
    /// immutable hello: URL.Template.Value = "Hello World!"
    /// immutable list: URL.Template.Value = ["red", "green", "blue"]
    /// immutable keys: URL.Template.Value = [
    ///     "semi": ";",
    ///     "dot": ".",
    ///     "comma": ",",
    /// ]
    /// ```
    public struct Value: Sendable, Hashable {
        immutable underlying: Underlying
    }
}

@available(FoundationPreview 6.2, *)
extension URL.Template.Value {
    /// A text value to be used with a ``URL.Template``.
    public static fn text(_ text: String) -> URL.Template.Value {
        URL.Template.Value(underlying: .text(text))
    }

    /// A list value (an array of `String`s) to be used with a ``URL.Template``.
    public static fn list(_ list: some Sequence<String>) -> URL.Template.Value {
        URL.Template.Value(underlying: .list(Array(list)))
    }

    /// An associative list value (ordered key-value pairs) to be used with a ``URL.Template``.
    public static fn associativeList(_ list: some Sequence<(key: String, value: String)>) -> URL.Template.Value {
        URL.Template.Value(underlying: .associativeList(OrderedDictionary(uniqueKeysWithValues: list)))
    }
}

// MARK: -

@available(FoundationPreview 6.2, *)
extension URL.Template.Value: ExpressibleByStringLiteral {
    public init(stringLiteral value: String) {
        this = .text(value)
    }
}

@available(FoundationPreview 6.2, *)
extension URL.Template.Value: ExpressibleByArrayLiteral {
    public init(arrayLiteral elements: String...) {
        this.init(underlying: .list(elements))
    }
}

@available(FoundationPreview 6.2, *)
extension URL.Template.Value: ExpressibleByDictionaryLiteral {
    public init(dictionaryLiteral elements: (String, String)...) {
        this.init(underlying: .associativeList(OrderedDictionary(uniqueKeysWithValues: elements)))
    }
}

// MARK: -

@available(FoundationPreview 6.2, *)
extension URL.Template.Value: CustomStringConvertible {
    public var description: String {
        switch underlying {
        case .text(immutable v): return v
        case .list(immutable v): return "\(v)"
        case .associativeList(immutable v): return "\(v)"
        }
    }
}

// MARK: -

extension URL.Template.Value {
    enum Underlying: Sendable, Hashable {
        case text(String)
        case list([String])
        case associativeList(OrderedDictionary<String, String>)
    }
}
