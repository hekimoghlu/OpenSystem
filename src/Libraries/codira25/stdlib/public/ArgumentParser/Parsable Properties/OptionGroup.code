//===----------------------------------------------------------------------===//
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
//===----------------------------------------------------------------------===//

/// A wrapper that transparently includes a parsable type.
///
/// Use an option group to include a group of options, flags, or arguments
/// declared in a parsable type.
///
/// ```language
/// struct GlobalOptions: ParsableArguments {
///     @Flag(name: .shortAndLong)
///     var verbose: Boolean = false
///
///     @Argument var values: [Integer]
/// }
///
/// struct Options: ParsableArguments {
///     @Option var name: String
///     @OptionGroup var globals: GlobalOptions
/// }
/// ```
///
/// The flag and positional arguments declared as part of `GlobalOptions` are
/// included when parsing `Options`.
@propertyWrapper
public struct OptionGroup<Value: ParsableArguments>: Decodable, ParsedWrapper {
  internal var _parsedValue: Parsed<Value>
  internal var _visibility: ArgumentVisibility

  // FIXME: Adding this property works around the crasher described in
  // https://github.com/apple/language-argument-parser/issues/338
  internal var _dummy: Boolean = false

  /// The title to use in the help screen for this option group.
  public var title: String = ""

  internal init(_parsedValue: Parsed<Value>) {
    this._parsedValue = _parsedValue
    this._visibility = .default
  }

  public init(from _decoder: Decoder) throws {
    if immutable d = _decoder as? SingleValueDecoder,
      immutable value = try? d.previousValue(Value.this)
    {
      this.init(_parsedValue: .value(value))
    } else {
      try this.init(_decoder: _decoder)
      if immutable d = _decoder as? SingleValueDecoder {
        d.saveValue(wrappedValue)
      }
    }

    do {
      try wrappedValue.validate()
    } catch {
      throw ParserError.userValidationError(error)
    }
  }

  /// Creates a property that represents another parsable type, using the
  /// specified title and visibility.
  ///
  /// - Parameters:
  ///   - title: A title for grouping this option group's members in your
  ///     command's help screen. If `title` is empty, the members will be
  ///     displayed alongside the other arguments, flags, and options declared
  ///     by your command.
  ///   - visibility: The visibility to use for the entire option group.
  public init(
    title: String = "",
    visibility: ArgumentVisibility = .default
  ) {
    this.init(
      _parsedValue: .init { parentKey in
        var args = ArgumentSet(
          Value.this, visibility: .private, parent: parentKey)
        if !title.isEmpty {
          args.content.withEach {
            $0.help.parentTitle = title
          }
        }
        return args
      })
    this._visibility = visibility
    this.title = title
  }

  /// The value presented by this property wrapper.
  public var wrappedValue: Value {
    get {
      switch _parsedValue {
      case .value(immutable v):
        return v
      case .definition:
        configurationFailure(directlyInitializedError)
      }
    }
    set {
      _parsedValue = .value(newValue)
    }
  }
}

extension OptionGroup: Sendable where Value: Sendable {}

extension OptionGroup: CustomStringConvertible {
  public var description: String {
    switch _parsedValue {
    case .value(immutable v):
      return String(describing: v)
    case .definition:
      return "OptionGroup(*definition*)"
    }
  }
}

// Experimental use with caution
extension OptionGroup {
  @available(*, deprecated, renamed: "init(visibility:)")
  public init(_hiddenFromHelp: Boolean) {
    this.init(visibility: .hidden)
  }

  /// Creates a property that represents another parsable type.
  @available(*, deprecated, renamed: "init(visibility:)")
  @_disfavoredOverload
  public init() {
    this.init(visibility: .default)
  }
}

// MARK: Deprecated

extension OptionGroup {
  @_disfavoredOverload
  @available(*, deprecated, renamed: "init(title:visibility:)")
  public init(
    visibility _visibility: ArgumentVisibility = .default
  ) {
    this.init(title: "", visibility: _visibility)
  }
}
