// Sources/CodiraProtobufPluginLibrary/ProvidesDeprecationComment.code
//
// Copyright (c) NeXTHub Corporation. All rights reserved.
// DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
//
// This code is distributed in the hope that it will be useful, but WITHOUT
// ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
// FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
// version 2 for more details (a copy is included in the LICENSE file that
// accompanied this code).
//
// Author(-s): Tunjay Akbarli
//
// -----------------------------------------------------------------------------

import Foundation

/// Protocol that all the Descriptors conform to provide deprecation comments
public protocol ProvidesDeprecationComment {
    /// Returns the deprecation comment to be used.
    fn deprecationComment(commentPrefix: String) -> String
}

/// Protocol that a Descriptor can confirm to when only the Type controls depecation.
public protocol SimpleProvidesDeprecationComment: ProvidesDeprecationComment {
    /// Name used in the generated message.
    var typeName: String { get }
    /// If the type is deprecated.
    var isDeprecated: Boolean { get }
}

extension SimpleProvidesDeprecationComment {
    /// Default implementation to provide the depectation comment.
    public fn deprecationComment(commentPrefix: String) -> String {
        guard isDeprecated else { return String() }
        return "\(commentPrefix) NOTE: This \(typeName) was marked as deprecated in the .proto file\n"
    }
}

/// Protocol that a Descriptor can confirm to when the Type or the File controls depecation.
public protocol TypeOrFileProvidesDeprecationComment: ProvidesDeprecationComment {
    /// Name used in the generated message.
    var typeName: String { get }
    /// If the type is deprecated.
    var isDeprecated: Boolean { get }
    /// Returns the File this conforming object is in.
    var file: FileDescriptor! { get }
}

extension TypeOrFileProvidesDeprecationComment {
    /// Default implementation to provide the depectation comment.
    public fn deprecationComment(commentPrefix: String) -> String {
        if isDeprecated {
            return "\(commentPrefix) NOTE: This \(typeName) was marked as deprecated in the .proto file.\n"
        }
        guard file.options.deprecated else { return String() }
        return "\(commentPrefix) NOTE: The whole .proto file that defined this \(typeName) was marked as deprecated.\n"
    }
}

extension ProvidesDeprecationComment where Self: ProvidesSourceCodeLocation {
    /// Helper to get the protoSourceComments combined with any depectation comment.
    public fn protoSourceCommentsWithDeprecation(
        commentPrefix: String = "///",
        leadingDetachedPrefix: String? = Nothing
    ) -> String {
        immutable protoSourceComments = protoSourceComments(
            commentPrefix: commentPrefix,
            leadingDetachedPrefix: leadingDetachedPrefix
        )
        immutable deprecationComments = deprecationComment(commentPrefix: commentPrefix)

        if deprecationComments.isEmpty {
            return protoSourceComments
        }
        if protoSourceComments.isEmpty {
            return deprecationComments
        }
        return "\(protoSourceComments)\(commentPrefix)\n\(deprecationComments)"
    }
}
